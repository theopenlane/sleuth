<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sleuth — Domain Intelligence Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --font-display: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
      --clr-bg: #09151d;
      --clr-surface: #233440;
      --clr-surface-alt: #162431;
      --clr-border: #394b58;
      --clr-border-light: #2a3d4a;
      --clr-text: #ffffff;
      --clr-text-secondary: #9aa5b0;
      --clr-text-muted: #6b7682;
      --clr-primary: #60e8c9;
      --clr-primary-light: rgba(96, 232, 201, 0.12);
      --clr-accent: #2dcdad;
      --clr-success: #21c55d;
      --clr-success-bg: rgba(33, 197, 93, 0.15);
      --clr-warning: #ff842c;
      --clr-warning-bg: rgba(255, 132, 44, 0.15);
      --clr-danger: #f45b50;
      --clr-danger-bg: rgba(244, 91, 80, 0.15);
      --clr-high: #f59e0b;
      --clr-high-bg: rgba(245, 158, 11, 0.15);
      --clr-info: #6392ff;
      --clr-info-bg: rgba(99, 146, 255, 0.15);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.15);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-display);
      background: var(--clr-bg);
      color: var(--clr-text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Header ── */
    .site-header {
      background: var(--clr-surface-alt);
      border-bottom: 1px solid var(--clr-border);
      padding: 0.65rem 2rem;
      color: white;
    }
    .site-header-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      position: relative;
    }
    .site-logo { flex-shrink: 0; }
    .site-logo svg { display: block; }
    .site-title-group {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .site-title-icon {
      width: 18px;
      height: 18px;
      color: var(--clr-primary);
      flex-shrink: 0;
    }
    .site-title {
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: -0.03em;
    }

    /* ── Main container ── */
    .container {
      max-width: 1280px;
      margin: 1.5rem auto 3rem;
      padding: 0 2rem;
    }

    /* ── Mode selector ── */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.75rem;
    }
    @media (max-width: 960px) {
      .mode-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 600px) {
      .mode-grid { grid-template-columns: 1fr 1fr; }
    }
    .mode-card {
      background: var(--clr-surface);
      border: 2px solid var(--clr-border);
      border-radius: var(--radius-md);
      padding: 1.1rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }
    .mode-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--clr-accent), var(--clr-primary));
      opacity: 0;
      transition: opacity 0.2s;
    }
    .mode-card:hover {
      border-color: var(--clr-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .mode-card.active {
      border-color: var(--clr-primary);
      background: var(--clr-primary-light);
    }
    .mode-card.active::before { opacity: 1; }
    .mode-card-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.6rem;
      font-size: 0.85rem;
      font-weight: 700;
      font-family: var(--font-mono);
      color: white;
    }
    .mode-card-icon.scan { background: #3b82f6; }
    .mode-card-icon.email { background: #8b5cf6; }
    .mode-card-icon.full { background: #0891b2; }
    .mode-card-icon.comply { background: #059669; }
    .mode-card-icon.enrich { background: #d97706; }
    .mode-card h3 {
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
      letter-spacing: -0.01em;
    }
    .mode-card p {
      font-size: 0.72rem;
      color: var(--clr-text-secondary);
      line-height: 1.45;
    }

    /* ── Input area ── */
    .input-panel {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }
    .input-group {
      flex: 1;
    }
    .input-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--clr-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.4rem;
    }
    .input-group input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border: 2px solid var(--clr-border);
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--clr-text);
      transition: border-color 0.2s, background 0.2s;
      background: var(--clr-surface-alt);
    }
    .input-group input:focus {
      outline: none;
      border-color: var(--clr-primary);
      background: var(--clr-bg);
    }
    .input-group input::placeholder {
      color: var(--clr-text-muted);
      font-weight: 400;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-bottom: 0.3rem;
    }
    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--clr-primary);
      cursor: pointer;
    }
    .checkbox-row label {
      font-size: 0.82rem;
      color: var(--clr-text-secondary);
      cursor: pointer;
    }
    .btn-scan {
      background: var(--clr-accent);
      color: #09151d;
      border: none;
      padding: 0.7rem 2rem;
      font-family: var(--font-display);
      font-size: 0.88rem;
      font-weight: 700;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      letter-spacing: -0.01em;
    }
    .btn-scan:hover { background: var(--clr-primary); transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-scan:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    @media (max-width: 600px) {
      .input-panel { flex-direction: column; align-items: stretch; }
      .btn-scan { width: 100%; }
    }

    /* ── Loading ── */
    .loading {
      display: none;
      padding: 3rem 2rem;
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-lg);
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    .loading.show { display: block; }
    .loading-spinner {
      width: 36px;
      height: 36px;
      margin: 0 auto 1rem;
      border: 3px solid var(--clr-border);
      border-top-color: var(--clr-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--clr-text);
      margin-bottom: 0.25rem;
    }
    .loading-sub {
      font-size: 0.82rem;
      color: var(--clr-text-muted);
    }

    /* ── Results shell ── */
    .results {
      display: none;
      animation: fadeUp 0.4s ease;
    }
    .results.show { display: block; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-bottom: 2px solid var(--clr-accent);
      color: white;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    .result-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .result-body {
      background: var(--clr-surface-alt);
      border: 1px solid var(--clr-border);
      border-top: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      padding: 1.75rem;
    }

    /* ── Header action buttons ── */
    .header-actions {
      display: flex;
      gap: 0.4rem;
    }
    .action-btn {
      padding: 0.35rem 0.75rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 0.72rem;
      font-weight: 500;
      color: var(--clr-text-muted);
      transition: all 0.15s;
    }
    .action-btn:hover {
      border-color: var(--clr-primary);
      color: var(--clr-primary);
      background: rgba(77,198,173,0.08);
    }

    /* ── Summary cards ── */
    /* ── Section title ── */
    .section-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--clr-text);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin: 1.75rem 0 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--clr-border);
    }

    /* ── Two-column layout for complete analysis ── */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 0.5rem;
    }
    @media (max-width: 860px) {
      .two-col { grid-template-columns: 1fr; }
    }
    .two-col .col-card {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .col-card-header {
      padding: 0.85rem 1.1rem;
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--clr-text-secondary);
      border-bottom: 1px solid var(--clr-border-light);
      background: var(--clr-surface-alt);
    }
    .col-card-body {
      padding: 1.1rem;
    }

    /* ── Intel score ── */
    .intel-score {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .score-item {
      text-align: center;
      padding: 1rem;
      background: var(--clr-surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--clr-border-light);
    }
    .score-item .label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.4rem;
    }
    .score-item .value {
      font-family: var(--font-mono);
      font-size: 1.4rem;
      font-weight: 600;
    }
    .risk-none { color: var(--clr-text-muted); }
    .risk-low { color: var(--clr-success); }
    .risk-medium { color: var(--clr-warning); }
    .risk-high { color: var(--clr-high); }
    .risk-critical { color: var(--clr-danger); }

    .recommendation {
      padding: 0.9rem 1.1rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1.25rem;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .recommend-approve { background: var(--clr-success-bg); color: var(--clr-success); border-left: 4px solid var(--clr-success); }
    .recommend-review { background: var(--clr-warning-bg); color: var(--clr-warning); border-left: 4px solid var(--clr-warning); }
    .recommend-reject { background: var(--clr-danger-bg); color: var(--clr-danger); border-left: 4px solid var(--clr-danger); }

    .flags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 1.25rem;
    }
    .flag {
      padding: 0.2rem 0.65rem;
      border-radius: 100px;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .flag.active { background: var(--clr-danger); color: white; }
    .flag.inactive { background: var(--clr-surface); color: var(--clr-text-muted); border: 1px solid var(--clr-border-light); }

    /* ── Legacy check items (for scan-only results) ── */
    .check-item {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-md);
      margin-bottom: 0.6rem;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .check-item:hover { box-shadow: var(--shadow-sm); }
    .check-header {
      padding: 0.9rem 1.1rem;
      font-size: 0.82rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.15s;
    }
    .check-header:hover { background: var(--clr-surface-alt); }
    .check-status {
      padding: 0.2rem 0.6rem;
      border-radius: 100px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .status-pass { background: var(--clr-success-bg); color: var(--clr-success); }
    .status-fail { background: var(--clr-danger-bg); color: var(--clr-danger); }
    .status-error { background: var(--clr-danger-bg); color: var(--clr-danger); }

    .check-details {
      padding: 1rem 1.1rem;
      border-top: 1px solid var(--clr-border-light);
      display: none;
      background: var(--clr-surface-alt);
    }
    .check-details.show { display: block; }

    .finding {
      padding: 0.7rem 0.9rem;
      margin-bottom: 0.4rem;
      border-left: 3px solid;
      background: var(--clr-surface);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-size: 0.85rem;
    }
    .finding.critical { border-color: var(--clr-danger); }
    .finding.high { border-color: var(--clr-high); }
    .finding.medium { border-color: var(--clr-warning); }
    .finding.low { border-color: var(--clr-primary); }
    .finding.info { border-color: var(--clr-text-muted); }
    .finding-header { font-weight: 600; margin-bottom: 0.15rem; }
    .finding-details { font-size: 0.8rem; color: var(--clr-text-secondary); }

    .severity-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 100px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-right: 0.4rem;
      vertical-align: middle;
    }
    .severity-critical { background: var(--clr-danger-bg); color: var(--clr-danger); }
    .severity-high { background: var(--clr-high-bg); color: var(--clr-high); }
    .severity-medium { background: var(--clr-warning-bg); color: var(--clr-warning); }
    .severity-low { background: var(--clr-info-bg); color: var(--clr-info); }
    .severity-info { background: rgba(107,118,130,0.15); color: var(--clr-text-muted); }

    /* ── Compliance: coverage list ── */
    .coverage-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .coverage-list.tech-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    .coverage-row {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.6rem 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--clr-border-light);
      background: var(--clr-surface-alt);
      transition: border-color 0.15s;
    }
    .coverage-row:hover { border-color: var(--clr-border); }
    .coverage-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 0.3rem;
    }
    .coverage-indicator.found { background: var(--clr-success); box-shadow: 0 0 0 3px var(--clr-success-bg); }
    .coverage-indicator.missing { background: var(--clr-border); }
    .coverage-body { flex: 1; min-width: 0; }
    .coverage-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--clr-text);
    }
    .coverage-label.missing-text { color: var(--clr-text-muted); }
    .coverage-pages {
      margin-top: 0.2rem;
    }
    .coverage-page-link {
      display: block;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--clr-primary);
      text-decoration: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.6;
    }
    .coverage-page-link:hover { text-decoration: underline; }
    .coverage-page-summary {
      font-size: 0.68rem;
      color: var(--clr-text-muted);
      line-height: 1.4;
      margin-top: 0.1rem;
    }

    /* ── Interesting subdomains table ── */
    .subdomain-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.78rem;
      margin-bottom: 1.5rem;
    }
    .subdomain-table th {
      text-align: left;
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--clr-text-muted);
      padding: 0.5rem 0.75rem;
      border-bottom: 2px solid var(--clr-border);
    }
    .subdomain-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--clr-border-light);
      color: var(--clr-text);
    }
    .subdomain-table tr:last-child td { border-bottom: none; }
    .subdomain-table .status-live {
      color: var(--clr-success);
      font-weight: 600;
    }
    .subdomain-table .status-dead {
      color: var(--clr-text-muted);
    }
    .subdomain-table a {
      color: var(--clr-primary);
      text-decoration: none;
      font-family: var(--font-mono);
      font-size: 0.72rem;
    }
    .subdomain-table a:hover { text-decoration: underline; }

    /* ── Compliance: frameworks ── */
    .frameworks-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }
    .framework-tag {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      font-weight: 500;
      padding: 0.25rem 0.65rem;
      border-radius: 100px;
      background: var(--clr-info-bg);
      color: var(--clr-info);
      border: 1px solid rgba(99,146,255,0.3);
    }

    /* ── Enrichment: profile card ── */
    .profile-card {
      background: var(--clr-surface-alt);
      border: 1px solid var(--clr-border-light);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .profile-card.standalone {
      margin-bottom: 1.5rem;
    }
    .profile-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--clr-border-light);
    }
    .profile-name {
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 0.25rem;
    }
    .profile-desc {
      font-size: 0.82rem;
      color: var(--clr-text-secondary);
      line-height: 1.5;
    }
    .social-links {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }
    .social-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 6px;
      background: var(--clr-surface);
      border: 1px solid var(--clr-border-light);
      color: var(--clr-text-muted);
      transition: color 0.15s, border-color 0.15s;
    }
    .social-badge:hover {
      color: var(--clr-primary);
      border-color: var(--clr-primary);
    }
    .social-badge svg {
      width: 14px;
      height: 14px;
    }
    .profile-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }
    .profile-meta-item {
      padding: 0.85rem 1.25rem;
      border-bottom: 1px solid var(--clr-border-light);
      border-right: 1px solid var(--clr-border-light);
    }
    .profile-meta-item:nth-child(2n) { border-right: none; }
    .profile-meta-item:last-child { border-bottom: none; border-right: none; }
    .profile-meta-item:nth-last-child(2):nth-child(odd) { border-bottom: none; }
    .profile-meta-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.2rem;
    }
    .profile-meta-value {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--clr-text);
    }
    .profile-products {
      padding: 1rem 1.25rem;
    }
    .product-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.35rem;
    }
    .product-tag {
      font-size: 0.72rem;
      font-weight: 500;
      padding: 0.2rem 0.6rem;
      border-radius: 100px;
      background: var(--clr-surface);
      color: var(--clr-text-secondary);
      border: 1px solid var(--clr-border-light);
    }

    /* ── Technical details ── */
    details {
      margin-top: 0.5rem;
      border: 1px solid var(--clr-border-light);
      border-radius: var(--radius-sm);
      background: var(--clr-surface);
    }
    details summary {
      cursor: pointer;
      padding: 0.6rem 0.9rem;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--clr-primary);
      user-select: none;
    }
    details summary:hover { color: var(--clr-accent); }
    details[open] summary { border-bottom: 1px solid var(--clr-border-light); }
    pre {
      background: #0d1b26;
      color: #c8d5df;
      padding: 1rem;
      margin: 0;
      overflow-x: auto;
      font-family: var(--font-mono);
      font-size: 0.78rem;
      line-height: 1.6;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }

    /* ── Empty state ── */
    .empty-state {
      text-align: center;
      padding: 2rem 1.5rem;
      color: var(--clr-text-muted);
    }
    .empty-state p {
      font-size: 0.85rem;
    }
    .pending-text {
      animation: pulse-fade 1.5s ease-in-out infinite;
    }
    @keyframes pulse-fade {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--clr-surface);
      color: var(--clr-text);
      border: 1px solid var(--clr-border);
      padding: 0.8rem 1.2rem;
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.25s;
      z-index: 1000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* ── Technology cards ── */
    .tech-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.6rem;
    }
    .tech-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.7rem 0.9rem;
      background: var(--clr-surface);
      border: 1px solid var(--clr-border-light);
      border-radius: var(--radius-md);
      transition: border-color 0.15s;
    }
    .tech-card:hover { border-color: var(--clr-border); }
    .tech-logo {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      flex-shrink: 0;
      object-fit: contain;
    }
    .tech-info { min-width: 0; }
    .tech-name {
      font-size: 0.82rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tech-category {
      font-size: 0.65rem;
      color: var(--clr-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tech-source {
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 1px 6px;
      border-radius: 3px;
      display: inline-block;
      margin-top: 2px;
      background: rgba(255,255,255,0.06);
      color: var(--clr-text-muted);
    }
    .tech-source-wappalyzer { background: rgba(99,179,237,0.12); color: #63b3ed; }
    .tech-source-dns { background: rgba(154,230,180,0.12); color: #9ae6b4; }
    .tech-source-subdomain { background: rgba(214,188,250,0.12); color: #d6bcfa; }
    .tech-source-infrastructure { background: rgba(251,191,36,0.12); color: #fbbf24; }
    .tech-source-compliance { background: rgba(96,232,201,0.12); color: #60e8c9; }

    /* ── Technology row in coverage-style list ── */
    .tech-row-logo {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      flex-shrink: 0;
      object-fit: contain;
    }
    .tech-row-logo-placeholder {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      border-radius: 3px;
      background: var(--clr-border-light);
    }
    .tech-row-category {
      font-size: 0.65rem;
      color: var(--clr-text-muted);
    }

    /* ── Security finding rows ── */
    .finding-row {
      border-radius: var(--radius-sm);
      border: 1px solid var(--clr-border-light);
      background: var(--clr-surface-alt);
    }
    .finding-row:hover { border-color: var(--clr-border); }
    .finding-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.55rem 0.85rem;
      cursor: pointer;
      list-style: none;
    }
    .finding-header::-webkit-details-marker { display: none; }
    .finding-header::marker { display: none; }
    .finding-chevron {
      font-size: 0.6rem;
      color: var(--clr-text-muted);
      transition: transform 0.15s;
      flex-shrink: 0;
      width: 0.7rem;
    }
    .finding-row[open] .finding-chevron { transform: rotate(90deg); }
    .severity-badge {
      font-family: var(--font-mono);
      font-size: 0.62rem;
      font-weight: 600;
      padding: 0.15rem 0.45rem;
      border-radius: 100px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      flex-shrink: 0;
    }
    .severity-badge-critical { background: var(--clr-danger-bg); color: var(--clr-danger); }
    .severity-badge-high { background: var(--clr-high-bg); color: var(--clr-high); }
    .severity-badge-medium { background: var(--clr-warning-bg); color: var(--clr-warning); }
    .severity-badge-low { background: var(--clr-info-bg); color: var(--clr-info); }
    .severity-badge-info { background: rgba(255,255,255,0.06); color: var(--clr-text-muted); }
    .finding-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--clr-text);
      flex: 1;
      min-width: 0;
    }
    .finding-detail {
      padding: 0.5rem 0.85rem 0.75rem;
      border-top: 1px solid var(--clr-border-light);
    }
    .finding-detail-row {
      display: flex;
      gap: 0.5rem;
      font-size: 0.72rem;
      line-height: 1.6;
    }
    .finding-detail-label {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--clr-text-muted);
      white-space: nowrap;
      min-width: 5.5rem;
    }
    .finding-detail-value {
      color: var(--clr-text-secondary);
      word-break: break-word;
    }

    /* ── Compact intel score ── */
    .intel-score.compact {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.85rem;
    }

    /* ── Company logo ── */
    .company-logo {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      object-fit: contain;
      background: white;
    }
    .profile-header-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* ── Result domain highlight ── */
    .result-domain { color: var(--clr-primary); }

    /* ── Skipped status ── */
    .status-skipped { background: rgba(107,118,130,0.15); color: var(--clr-text-muted); }

    /* ── Summary card color helpers ── */
    .risk-muted { color: var(--clr-text-muted); }
    .risk-info { color: var(--clr-info); }

    /* ── Email Auth + Domain Registration panels ── */
    .posture-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    @media (max-width: 860px) {
      .posture-grid { grid-template-columns: 1fr; }
    }
    .posture-card {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .posture-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 1.1rem;
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--clr-text-secondary);
      border-bottom: 1px solid var(--clr-border-light);
      background: var(--clr-surface-alt);
    }
    .posture-card-body {
      padding: 1rem 1.1rem;
    }

    /* Grade badge */
    .grade-badge {
      font-family: var(--font-mono);
      font-size: 0.82rem;
      font-weight: 700;
      padding: 0.15rem 0.55rem;
      border-radius: var(--radius-sm);
      letter-spacing: 0.02em;
    }
    .grade-A { background: var(--clr-success-bg); color: var(--clr-success); }
    .grade-B { background: var(--clr-info-bg); color: var(--clr-info); }
    .grade-C { background: var(--clr-warning-bg); color: var(--clr-warning); }
    .grade-D { background: var(--clr-high-bg); color: var(--clr-high); }
    .grade-F { background: var(--clr-danger-bg); color: var(--clr-danger); }

    /* Protocol row */
    .protocol-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 0;
      border-bottom: 1px solid var(--clr-border-light);
      font-size: 0.82rem;
    }
    .protocol-row:last-child { border-bottom: none; }
    .protocol-label {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--clr-text);
      min-width: 3.5rem;
    }
    .protocol-status {
      font-size: 0.72rem;
      font-weight: 600;
      padding: 0.1rem 0.5rem;
      border-radius: 100px;
    }
    .protocol-ok { background: var(--clr-success-bg); color: var(--clr-success); }
    .protocol-warn { background: var(--clr-warning-bg); color: var(--clr-warning); }
    .protocol-miss { background: rgba(107,118,130,0.15); color: var(--clr-text-muted); }
    .protocol-detail {
      font-size: 0.72rem;
      color: var(--clr-text-muted);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Domain registration detail rows */
    .reg-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--clr-border-light);
      font-size: 0.82rem;
    }
    .reg-row:last-child { border-bottom: none; }
    .reg-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .reg-value {
      font-family: var(--font-mono);
      font-weight: 500;
      color: var(--clr-text);
      font-size: 0.82rem;
    }
    .reg-age {
      font-family: var(--font-mono);
      font-size: 1.1rem;
      font-weight: 700;
      text-align: center;
      padding: 0.75rem 0 0.5rem;
    }
    .reg-age-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .dnssec-badge {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      font-weight: 600;
      padding: 0.1rem 0.5rem;
      border-radius: 100px;
    }
    .dnssec-enabled { background: var(--clr-success-bg); color: var(--clr-success); }
    .dnssec-disabled { background: rgba(107,118,130,0.15); color: var(--clr-text-muted); }

    /* ── Helpers ── */
    .hidden { display: none; }
    .mt-0 { margin-top: 0; }
  </style>
</head>
<body>

  <div class="site-header">
    <div class="site-header-inner">
      <div class="site-logo">
        <svg id="Openlane_Logo" width="160" height="30" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 388.66 73.61">
          <path fill="#303e4a" d="M33.02,7.16L3.35,58.22c-4.53,7.8-.82,14.18,8.24,14.18h59.35c7.77,0,12.31-6.44,8.45-13.43-1.74-3.15-3.6-6.24-5.4-9.36-5.91-10.24-11.82-20.47-17.73-30.71-2.37-4.1-4.73-8.2-7.1-12.3-4.56-7.24-11.72-7.07-16.14.54v.02Z"/>
          <path fill="#ffffff" d="M120.19,8.11c-14.04,0-23.84,9.86-23.84,23.97s9.8,23.97,23.84,23.97,23.84-9.86,23.84-23.97-9.8-23.97-23.84-23.97ZM120.19,50.19c-10.72,0-17.92-7.28-17.92-18.11s7.2-18.11,17.92-18.11,17.98,7.28,17.98,18.11-7.23,18.11-17.98,18.11Z"/>
          <path fill="#ffffff" d="M167.42,19.69c-5.3,0-9.95,2-13.14,5.56l-.28-4.74h-5.04v47.37h5.67v-17.04c3.23,3.34,7.75,5.21,12.79,5.21,10.29,0,17.77-7.66,17.77-18.21s-7.47-18.15-17.77-18.15ZM167.04,25.23c7.46,0,12.48,5.07,12.48,12.6s-5.01,12.67-12.48,12.67-12.54-5.09-12.54-12.67,5.16-12.6,12.54-12.6Z"/>
          <path fill="#ffffff" d="M206.89,19.69c-10.46,0-17.77,7.46-17.77,18.15s7.28,18.21,17.71,18.21c7.65,0,14.07-4.12,16.75-10.75l.55-1.35-6.2-.1-.28.56c-1.99,3.91-5.93,6.16-10.81,6.16-6.33,0-10.88-3.97-11.85-10.21h29.59l.02-.98c.14-5.95-1.7-11.18-5.16-14.73-3.17-3.25-7.51-4.96-12.55-4.96h0ZM206.89,25.17c6.28,0,10.76,3.79,11.93,9.96h-23.84c.98-6.09,5.55-9.96,11.9-9.96h0Z"/>
          <path fill="#ffffff" d="M246.75,19.69c-4.67,0-8.74,1.85-11.55,5.16l-.22-4.34h-5.05v34.71h5.67v-17.96c0-7.2,4.3-12.04,10.71-12.04,5.99,0,9.57,4.19,9.57,11.21v18.78h5.67v-19.1c0-9.99-5.81-16.44-14.79-16.44v.02Z"/>
          <rect fill="#ffffff" x="268.07" y="8.21" width="5.67" height="47.02"/>
          <path fill="#ffffff" d="M295.9,19.69c-7.4,0-13.06,4.07-14.76,10.62l-.33,1.25h5.74l.23-.68c1.21-3.56,4.72-5.78,9.18-5.78,5.5,0,9.06,3.16,9.06,8.05v1.34h-13.43c-7.37,0-12.14,4.12-12.14,10.49s5.24,10.75,13.34,10.75c5.15,0,9.55-1.63,12.64-4.65l.28,4.14h4.97v-22.26c0-7.82-6.08-13.28-14.79-13.28h.01ZM292.93,50.44c-4.81,0-7.8-2.11-7.8-5.52,0-3.11,2.65-5.2,6.59-5.2h13.37v.39c0,5.98-5.12,10.33-12.16,10.33Z"/>
          <path fill="#ffffff" d="M332.84,19.69c-4.67,0-8.74,1.85-11.55,5.16l-.22-4.34h-5.05v34.71h5.67v-17.96c0-7.2,4.3-12.04,10.71-12.04,5.99,0,9.57,4.19,9.57,11.21v18.78h5.67v-19.1c0-9.99-5.81-16.44-14.79-16.44v.02Z"/>
          <path fill="#ffffff" d="M387.24,39.38c.14-5.95-1.7-11.18-5.16-14.73-3.17-3.25-7.51-4.96-12.55-4.96-10.46,0-17.77,7.46-17.77,18.15s7.28,18.21,17.71,18.21c7.65,0,14.07-4.12,16.75-10.75l.55-1.35-6.2-.1-.28.56c-1.99,3.91-5.93,6.16-10.81,6.16-6.33,0-10.88-3.97-11.85-10.21h29.59l.02-.98h0ZM369.53,25.17c6.28,0,10.76,3.79,11.93,9.96h-23.84c.98-6.09,5.55-9.96,11.9-9.96h.01Z"/>
          <path fill="#4dc6ad" d="M43.04,61.32c-1.25-1.6-2.34-3.48-2.33-5.51.02-8.49,13.79-12.32,18.87-17.07,1.99-1.86,3.59-4.34,4.11-6.96l-6.84-11.85c-1.72-1.14-3.58-2.11-5.43-3.01-4.24-2.07-13.03-5.38-19.89-7.17l-1.29,2.23c.51.26,1.02.51,1.53.77,3.16,1.61,6.34,3.25,9.03,5.61,1.04.91,2.03,1.99,2.4,3.32.52,1.9-.37,3.96-1.75,5.37-5,5.05-13.94,6.49-20.34,8.97-2.19.85-4.36,1.77-6.47,2.81L3.35,58.22c-4.53,7.8-.82,14.18,8.24,14.18h49.82c-1.79-.49-3.57-1.08-5.38-1.81-4.99-2.01-9.67-5.04-12.98-9.28h0Z"/>
        </svg>
      </div>
      <div class="site-title-group">
        <svg class="site-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
        <span class="site-title">Sleuth</span>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- Mode selector -->
    <div class="mode-grid">
      <div class="mode-card active" data-mode="domain">
        <div class="mode-card-icon scan">DS</div>
        <h3>Domain Scan</h3>
        <p>Infrastructure analysis: DNS, HTTP, TLS, and vulnerability detection</p>
      </div>
      <div class="mode-card" data-mode="email">
        <div class="mode-card-icon email">EC</div>
        <h3>Email Check</h3>
        <p>Threat intelligence lookup against malicious email databases</p>
      </div>
      <div class="mode-card" data-mode="both">
        <div class="mode-card-icon full">CA</div>
        <h3>Complete Analysis</h3>
        <p>Full scan, compliance discovery, and domain enrichment in one pass</p>
      </div>
      <div class="mode-card" data-mode="compliance">
        <div class="mode-card-icon comply">CD</div>
        <h3>Compliance Discovery</h3>
        <p>Discover privacy, legal, and compliance pages across a domain</p>
      </div>
      <div class="mode-card" data-mode="enrich">
        <div class="mode-card-icon enrich">DE</div>
        <h3>Domain Enrichment</h3>
        <p>Company profile extraction via browser rendering</p>
      </div>
    </div>

    <!-- Input panel -->
    <div class="input-panel">
      <div class="input-group" id="domainInput">
        <label for="domain">Domain</label>
        <input type="text" id="domain" placeholder="example.com" />
      </div>
      <div class="input-group hidden" id="emailInput">
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="user@example.com" />
      </div>
      <div class="checkbox-row hidden" id="scanDomainOption">
        <input type="checkbox" id="scanDomain" />
        <label for="scanDomain">Also run full domain scan</label>
      </div>
      <button class="btn-scan" id="scanBtn">Run Analysis</button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">Analyzing...</div>
      <div class="loading-sub" id="loadingSub">This may take a moment</div>
    </div>

    <!-- Results -->
    <div class="results" id="results">
      <div class="result-header" id="resultTitle">
        <h2>Results</h2>
      </div>
      <div class="result-body">
        <div id="resultBody"></div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    let currentMode = 'domain';
    let currentScanData = null;

    // ── Mode selection ──
    document.querySelectorAll('.mode-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        currentMode = card.dataset.mode;
        updateInputs();
      });
    });

    function updateInputs() {
      const domainInput = document.getElementById('domainInput');
      const emailInput = document.getElementById('emailInput');
      const scanOpt = document.getElementById('scanDomainOption');
      const btn = document.getElementById('scanBtn');

      domainInput.classList.add('hidden');
      emailInput.classList.add('hidden');
      scanOpt.classList.add('hidden');

      switch (currentMode) {
        case 'domain':
          domainInput.classList.remove('hidden');
          btn.textContent = 'Run Scan';
          break;
        case 'email':
          emailInput.classList.remove('hidden');
          btn.textContent = 'Check Email';
          break;
        case 'both':
          domainInput.classList.remove('hidden');
          document.querySelector('#domainInput label').textContent = 'Domain or Email';
          document.getElementById('domain').placeholder = 'example.com or user@example.com';
          btn.textContent = 'Full Analysis';
          return;
        case 'compliance':
          domainInput.classList.remove('hidden');
          document.querySelector('#domainInput label').textContent = 'Domain or Email';
          document.getElementById('domain').placeholder = 'example.com or user@example.com';
          btn.textContent = 'Discover Compliance';
          return;
        case 'enrich':
          domainInput.classList.remove('hidden');
          document.querySelector('#domainInput label').textContent = 'Domain or Email';
          document.getElementById('domain').placeholder = 'example.com or user@example.com';
          btn.textContent = 'Enrich Domain';
          return;
      }

      // Reset domain label for scan modes
      document.querySelector('#domainInput label').textContent = 'Domain';
      document.getElementById('domain').placeholder = 'example.com';
    }

    // ── Enter key to submit ──
    document.getElementById('domain').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('scanBtn').click();
      }
    });
    document.getElementById('email').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('scanBtn').click();
      }
    });

    // ── Submit handler ──
    document.getElementById('scanBtn').addEventListener('click', async () => {
      const domain = document.getElementById('domain').value.trim();
      const email = document.getElementById('email').value.trim();

      // Complete Analysis fires all three endpoints in parallel
      if (currentMode === 'both') {
        if (!domain) return alert('Enter a domain or email');
        await runCompleteAnalysis(domain);
        return;
      }

      let endpoint, body, loadingMsg, loadingSub;

      switch (currentMode) {
        case 'domain':
          if (!domain) return alert('Enter a domain');
          endpoint = '/api/scan';
          body = { domain };
          loadingMsg = 'Scanning ' + domain;
          loadingSub = 'Running DNS, HTTP, TLS, and vulnerability checks';
          break;
        case 'email':
          if (!email) return alert('Enter an email address');
          endpoint = '/api/scan';
          body = { email };
          loadingMsg = 'Checking ' + email;
          loadingSub = 'Querying threat intelligence feeds';
          break;
        case 'compliance': {
          if (!domain) return alert('Enter a domain or email');
          endpoint = '/api/compliance';
          const isEmail = domain.includes('@');
          body = isEmail ? { email: domain } : { domain, notify_slack: false };
          loadingMsg = 'Discovering compliance pages';
          loadingSub = 'Probing and classifying pages across ' + (isEmail ? domain.split('@')[1] : domain);
          break;
        }
        case 'enrich': {
          if (!domain) return alert('Enter a domain or email');
          endpoint = '/api/enrich';
          const isEmail = domain.includes('@');
          body = isEmail ? { email: domain, notify_slack: false } : { domain, notify_slack: false };
          loadingMsg = 'Enriching domain profile';
          loadingSub = 'Rendering and extracting company data via browser';
          break;
        }
      }

      document.getElementById('loading').classList.add('show');
      document.getElementById('loadingText').textContent = loadingMsg;
      document.getElementById('loadingSub').textContent = loadingSub;
      document.getElementById('results').classList.remove('show');
      document.getElementById('scanBtn').disabled = true;

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (!data.success) {
          const errMsg = data.error?.message || data.error || 'Request failed';
          throw new Error(errMsg);
        }

        currentScanData = data;

        switch (currentMode) {
          case 'domain':
          case 'email':
            displayScanResults(data);
            break;
          case 'compliance':
            displayComplianceResults(data);
            break;
          case 'enrich':
            displayEnrichResults(data);
            break;
        }
      } catch (error) {
        showToast('Error: ' + error.message);
        document.getElementById('results').classList.remove('show');
      } finally {
        document.getElementById('loading').classList.remove('show');
        document.getElementById('scanBtn').disabled = false;
      }
    });

    // ── Complete Analysis: parallel scan + compliance + enrich ──
    async function runCompleteAnalysis(input) {
      const isEmail = input.includes('@');
      const domainValue = isEmail ? input.split('@')[1] : input;
      const displayTarget = isEmail ? input : domainValue;

      document.getElementById('loading').classList.add('show');
      document.getElementById('loadingText').textContent = 'Analyzing ' + displayTarget;
      document.getElementById('loadingSub').textContent = 'Running scan, compliance discovery, and enrichment in parallel';
      document.getElementById('results').classList.remove('show');
      document.getElementById('scanBtn').disabled = true;

      const scanBody = isEmail ? { email: input, scan_domain: true } : { domain: domainValue };
      const complianceBody = isEmail ? { email: input, notify_slack: false } : { domain: domainValue, notify_slack: false };
      const enrichBody = isEmail ? { email: input, notify_slack: false } : { domain: domainValue, notify_slack: false };

      const state = { scan: null, compliance: null, enrich: null, rendered: false, failed: 0 };

      function renderCurrent() {
        currentScanData = { scan: state.scan, compliance: state.compliance, enrich: state.enrich };
        displayCompleteResults(displayTarget, state.scan, state.compliance, state.enrich);
        if (!state.rendered) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('results').classList.add('show');
          state.rendered = true;
        }
      }

      const headers = { 'Content-Type': 'application/json' };

      const scanPromise = fetch('/api/scan', { method: 'POST', headers, body: JSON.stringify(scanBody) })
        .then(r => r.json()).then(d => { if (d.success) { state.scan = d; renderCurrent(); } else { state.failed++; } })
        .catch(() => { state.failed++; });

      const compliancePromise = fetch('/api/compliance', { method: 'POST', headers, body: JSON.stringify(complianceBody) })
        .then(r => r.json()).then(d => { if (d.success) { state.compliance = d; renderCurrent(); } else { state.failed++; } })
        .catch(() => { state.failed++; });

      const enrichPromise = fetch('/api/enrich', { method: 'POST', headers, body: JSON.stringify(enrichBody) })
        .then(r => r.json()).then(d => { if (d.success) { state.enrich = d; renderCurrent(); } else { state.failed++; } })
        .catch(() => { state.failed++; });

      setResultHeader('Complete Analysis: <span class="result-domain">' + displayTarget + '</span>');

      await Promise.allSettled([scanPromise, compliancePromise, enrichPromise]);

      if (state.failed === 3) {
        showToast('Error: All analysis endpoints failed');
        document.getElementById('results').classList.remove('show');
      } else {
        renderCurrent();
      }

      document.getElementById('loading').classList.remove('show');
      document.getElementById('scanBtn').disabled = false;
    }

    // ── Shared: build coverage section with inline page links ──
    const coverageMap = [
      { label: 'Privacy Policy', key: 'has_privacy_policy', types: ['privacy_policy'] },
      { label: 'Terms of Service', key: 'has_terms_of_service', types: ['terms_of_service'] },
      { label: 'Trust Center', key: 'has_trust_center', types: ['trust_center'] },
      { label: 'DPA', key: 'has_dpa', types: ['dpa'] },
      { label: 'SOC 2', key: 'has_soc2', types: ['soc2_report'] },
      { label: 'Security Page', key: 'has_security_page', types: ['security'] },
      { label: 'Subprocessors', key: 'has_subprocessors', types: ['subprocessors'] },
      { label: 'Cookie Policy', key: 'has_cookie_policy', types: ['cookie_policy'] },
      { label: 'GDPR', key: 'has_gdpr', types: ['gdpr'] },
    ];

    function buildCoverageSection(summary, pages) {
      let html = '<div class="coverage-list">';
      const pagesList = pages || [];

      coverageMap.forEach(({ label, key, types: pageTypes }) => {
        const found = summary[key];
        const matchingPages = pagesList.filter(p => pageTypes.includes(p.page_type));

        html += '<div class="coverage-row">';
        html += `<div class="coverage-indicator ${found ? 'found' : 'missing'}"></div>`;
        html += '<div class="coverage-body">';
        html += `<div class="coverage-label ${found ? '' : 'missing-text'}">${label}</div>`;

        if (matchingPages.length > 0) {
          html += '<div class="coverage-pages">';
          matchingPages.forEach(page => {
            const title = page.title || page.url;
            html += `<a class="coverage-page-link" href="${page.url}" target="_blank" rel="noopener">${title}</a>`;
            if (page.summary) {
              html += `<div class="coverage-page-summary">${page.summary}</div>`;
            }
          });
          html += '</div>';
        }

        html += '</div></div>';
      });

      html += '</div>';
      return html;
    }

    function buildInterestingSubdomainsSection(scanData) {
      if (!scanData?.data?.results) return '';

      const subDiscovery = scanData.data.results.find(c => c.check_name === 'subdomain_discovery');
      if (!subDiscovery?.metadata?.interesting_subdomain_details) return '';

      const details = subDiscovery.metadata.interesting_subdomain_details;
      if (!details.length) return '';

      let html = '<div class="section-title">Interesting Subdomains</div>';
      html += '<table class="subdomain-table"><thead><tr>';
      html += '<th>Subdomain</th><th>Context</th><th>Status</th><th>Title</th>';
      html += '</tr></thead><tbody>';

      details.forEach(d => {
        const statusClass = d.live ? 'status-live' : 'status-dead';
        const statusText = d.live ? `Live (${d.status_code})` : 'Not responding';
        const titleText = d.title || '\u2014';
        const subLink = d.live && d.url
          ? `<a href="${d.url}" target="_blank" rel="noopener">${d.subdomain}</a>`
          : d.subdomain;

        html += `<tr>`;
        html += `<td>${subLink}</td>`;
        html += `<td>${d.context}</td>`;
        html += `<td class="${statusClass}">${statusText}</td>`;
        html += `<td>${titleText}</td>`;
        html += `</tr>`;
      });

      html += '</tbody></table>';
      return html;
    }

    // ── Per-check summary extraction ──
    // ── Aggregate checks into two virtual tabs ──
    function aggregateChecks(checks) {
      const securityFindings = [];
      const techCheck = checks.find(c => c.check_name === 'technology_detection');

      checks.forEach(c => {
        if (c.check_name === 'http_analysis' || c.check_name === 'nuclei_scan') {
          (c.findings || []).forEach(f => securityFindings.push({ ...f, source: c.check_name }));
        }
      });

      return { securityFindings, techCheck };
    }

    // ── Source label map ──
    const sourceLabels = {
      wappalyzer: 'Wappalyzer',
      dns: 'DNS TXT',
      subdomain: 'Subdomain',
      infrastructure: 'Infrastructure',
      compliance: 'Subprocessor',
    };

    // ── Technology list renderer (coverage-style vertical list with icons) ──
    // Merges detected_technologies, infrastructure findings, service_detection
    // findings, and compliance-discovered subprocessors into one deduplicated list.
    function buildTechnologyList(check, subprocessors) {
      const seenNames = new Set();
      const allItems = [];

      // Scanner-detected technologies (wappalyzer, DNS TXT, subdomain)
      const techs = check?.metadata?.detected_technologies || [];
      techs.forEach(tech => {
        const name = typeof tech === 'string' ? tech : tech.name;
        const key = name.toLowerCase();
        if (seenNames.has(key)) return;
        seenNames.add(key);
        const cats = typeof tech === 'object' ? (tech.categories || []).join(', ') : '';
        const website = typeof tech === 'object' ? (tech.website || '') : '';
        const source = typeof tech === 'object' ? (tech.source || '') : '';
        let logoDomain = '';
        try { if (website) logoDomain = new URL(website).hostname; } catch {}
        allItems.push({ name, categories: cats, logoDomain, source });
      });

      // Infrastructure findings (CDN, WAF, cloud)
      (check?.findings || []).forEach(f => {
        if (f.type !== 'technology') return;
        const parts = f.description.replace(/^(Technology|Service):\s*/, '').split(': ');
        const name = parts.length > 1 ? parts[1] : parts[0];
        const key = name.toLowerCase();
        if (seenNames.has(key)) return;
        seenNames.add(key);
        const cat = parts.length > 1 ? parts[0] : '';
        allItems.push({ name, categories: cat, logoDomain: name.toLowerCase().replace(/\s+/g, '') + '.com', source: 'infrastructure' });
      });

      // Compliance-discovered subprocessors / vendors
      (subprocessors || []).forEach(sp => {
        const key = sp.toLowerCase();
        if (seenNames.has(key)) return;
        seenNames.add(key);
        allItems.push({ name: sp, categories: 'Vendor / Subprocessor', logoDomain: sp.toLowerCase().replace(/\s+/g, '') + '.com', source: 'compliance' });
      });

      if (!allItems.length) return '<div class="empty-state"><p>No technologies detected</p></div>';

      let html = '<div class="coverage-list tech-grid">';
      allItems.forEach(item => {
        const logoUrl = item.logoDomain
          ? `https://www.google.com/s2/favicons?domain=${item.logoDomain}&sz=64`
          : '';
        const sourceLabel = item.source ? (sourceLabels[item.source] || item.source) : '';

        html += '<div class="coverage-row">';
        if (logoUrl) {
          html += `<img class="tech-row-logo" src="${logoUrl}" alt="${item.name}" onerror="this.replaceWith(document.createTextNode(''))" />`;
        } else {
          html += '<div class="tech-row-logo-placeholder"></div>';
        }
        html += '<div class="coverage-body">';
        html += `<div class="coverage-label">${item.name}</div>`;
        if (item.categories) html += `<div class="tech-row-category">${item.categories}</div>`;
        html += '</div>';
        if (sourceLabel) {
          html += `<div class="tech-source tech-source-${item.source}">${sourceLabel}</div>`;
        }
        html += '</div>';
      });
      html += '</div>';
      return html;
    }

    // ── Security findings list renderer (truncated titles, expandable details) ──
    function buildSecurityFindingsList(findings) {
      if (!findings.length) return '<div class="empty-state"><p>No security issues found</p></div>';

      const grouped = { critical: [], high: [], medium: [], low: [], info: [] };
      findings.forEach(f => grouped[f.severity]?.push(f));

      let html = '<div class="coverage-list">';
      ['critical', 'high', 'medium', 'low', 'info'].forEach(sev => {
        grouped[sev].forEach(f => {
          const raw = f.description || '';
          const details = f.details || '';

          // Parse title and long description from "Name: matcher -- Long description" format
          let title = raw;
          let longDesc = '';

          const dashSplit = raw.split(' -- ');
          if (dashSplit.length > 1) {
            title = dashSplit[0].trim();
            longDesc = dashSplit.slice(1).join(' -- ').trim();
          }

          // Strip matcher suffixes like ": missing-object-src"
          const colonMatch = title.match(/^(.+?):\s*(missing-|Detect|detect)/);
          if (colonMatch) title = colonMatch[1].trim();

          // Parse structured details (e.g. "Template: x | Host: y | Matched: z")
          const detailParts = [];
          if (longDesc) detailParts.push({ label: 'Description', value: longDesc });
          if (details) {
            const pipeSegments = details.split(' | ');
            pipeSegments.forEach(seg => {
              const idx = seg.indexOf(': ');
              if (idx > 0) {
                detailParts.push({ label: seg.substring(0, idx).trim(), value: seg.substring(idx + 2).trim() });
              } else {
                detailParts.push({ label: 'Info', value: seg.trim() });
              }
            });
          }
          if (f.type) detailParts.push({ label: 'Type', value: f.type });

          html += `<details class="finding-row">`;
          html += `<summary class="finding-header">`;
          html += `<span class="finding-chevron">\u25B8</span>`;
          html += `<span class="severity-badge severity-badge-${sev}">${sev}</span>`;
          html += `<span class="finding-title">${title}</span>`;
          html += `</summary>`;
          if (detailParts.length) {
            html += '<div class="finding-detail">';
            detailParts.forEach(d => {
              html += `<div class="finding-detail-row">`;
              html += `<span class="finding-detail-label">${d.label}</span>`;
              html += `<span class="finding-detail-value">${d.value}</span>`;
              html += `</div>`;
            });
            html += '</div>';
          }
          html += '</details>';
        });
      });
      html += '</div>';
      return html;
    }

    // ── Build findings HTML for a check ──
    function buildCheckFindings(check) {
      let html = '';
      if (check.findings?.length) {
        const grouped = { critical:[], high:[], medium:[], low:[], info:[] };
        check.findings.forEach(f => grouped[f.severity]?.push(f));
        ['critical','high','medium','low','info'].forEach(sev => {
          grouped[sev].forEach(f => {
            html += `<div class="finding ${sev}"><div class="finding-header"><span class="severity-badge severity-${sev}">${sev}</span> ${f.description}</div>${f.details ? `<div class="finding-details">${f.details}</div>` : ''}</div>`;
          });
        });
      } else if (!check.error) {
        html += '<div class="empty-state"><p>No issues found</p></div>';
      }

      if (check.metadata && Object.keys(check.metadata).length) {
        html += `<details><summary>Technical Details</summary><pre>${JSON.stringify(check.metadata, null, 2)}</pre></details>`;
      }

      return html;
    }

    // ── Build profile card HTML ──
    const socialPlatforms = [
      { key: 'linkedin', label: 'LinkedIn', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>' },
      { key: 'twitter', label: 'X', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>' },
      { key: 'github', label: 'GitHub', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>' },
      { key: 'discord', label: 'Discord', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286z"/></svg>' },
      { key: 'instagram', label: 'Instagram', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678a6.162 6.162 0 100 12.324 6.162 6.162 0 100-12.324zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405a1.441 1.441 0 11-2.882 0 1.441 1.441 0 012.882 0z"/></svg>' },
      { key: 'youtube', label: 'YouTube', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/><polygon fill="#162431" points="9.545,15.568 15.818,12 9.545,8.432"/></svg>' },
      { key: 'facebook', label: 'Facebook', icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>' },
    ];

    function buildSocialLinks(social) {
      if (!social) return '';
      const links = socialPlatforms.filter(p => social[p.key]);
      if (!links.length) return '';

      let html = '<div class="social-links">';
      links.forEach(({ key, label, icon }) => {
        html += `<a class="social-badge" href="${social[key]}" target="_blank" rel="noopener" title="${label}">${icon}</a>`;
      });
      html += '</div>';
      return html;
    }

    function buildProfileCard(enrichData, standalone) {
      const result = enrichData.data;
      const p = result.profile;
      let html = `<div class="profile-card${standalone ? ' standalone' : ''}">`;
      html += '<div class="profile-header">';
      html += '<div class="profile-header-row">';
      html += `<img class="company-logo" src="https://www.google.com/s2/favicons?domain=${result.domain}&sz=128" alt="${result.domain}" onerror="this.style.display='none'" />`;
      html += '<div>';
      html += `<div class="profile-name">${p.name || result.domain}</div>`;
      if (p.description) html += `<div class="profile-desc">${p.description}</div>`;
      html += buildSocialLinks(p.social_links);
      html += '</div></div>';
      html += '</div>';

      const metaFields = [];
      if (p.industry) metaFields.push(['Industry', p.industry]);
      if (p.products?.length) metaFields.push(['Products & Services', p.products.join(', ')]);
      if (p.location) metaFields.push(['Headquarters', p.location]);
      if (p.employee_range) metaFields.push(['Employees', p.employee_range]);
      if (p.founded_year) metaFields.push(['Founded', p.founded_year]);
      if (p.estimated_revenue) metaFields.push(['Revenue', p.estimated_revenue]);
      if (result.email) metaFields.push(['Contact Email', result.email]);

      if (metaFields.length) {
        html += '<div class="profile-meta">';
        metaFields.forEach(([label, value]) => {
          html += `<div class="profile-meta-item"><div class="profile-meta-label">${label}</div><div class="profile-meta-value">${value}</div></div>`;
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    // ── Email Auth section ──
    function buildEmailAuthSection(emailAuth) {
      if (!emailAuth) return '';

      const grade = emailAuth.grade || '?';
      let html = '<div class="posture-card">';
      html += '<div class="posture-card-header">';
      html += '<span>Email Authentication</span>';
      html += `<span class="grade-badge grade-${grade}">${grade}</span>`;
      html += '</div>';
      html += '<div class="posture-card-body">';

      // SPF row
      const spf = emailAuth.spf || {};
      const spfFound = spf.found;
      const spfStatus = !spfFound ? 'miss' : (spf.all_mechanism === '-all' || spf.all_mechanism === '~all' ? 'ok' : 'warn');
      const spfLabel = !spfFound ? 'Not found' : (spf.all_mechanism || 'Found');
      const spfDetail = spf.record || '';
      html += '<div class="protocol-row">';
      html += '<span class="protocol-label">SPF</span>';
      html += `<span class="protocol-status protocol-${spfStatus}">${spfLabel}</span>`;
      if (spfDetail) html += `<span class="protocol-detail" title="${spfDetail.replace(/"/g, '&quot;')}">${spfDetail}</span>`;
      html += '</div>';

      // DMARC row
      const dmarc = emailAuth.dmarc || {};
      const dmarcFound = dmarc.found;
      const dmarcStatus = !dmarcFound ? 'miss' : (dmarc.policy === 'reject' || dmarc.policy === 'quarantine' ? 'ok' : 'warn');
      const dmarcLabel = !dmarcFound ? 'Not found' : ('p=' + (dmarc.policy || '?'));
      const dmarcDetail = dmarc.record || '';
      html += '<div class="protocol-row">';
      html += '<span class="protocol-label">DMARC</span>';
      html += `<span class="protocol-status protocol-${dmarcStatus}">${dmarcLabel}</span>`;
      if (dmarcDetail) html += `<span class="protocol-detail" title="${dmarcDetail.replace(/"/g, '&quot;')}">${dmarcDetail}</span>`;
      html += '</div>';

      // DKIM row
      const dkim = emailAuth.dkim || {};
      const dkimFound = dkim.found;
      const dkimStatus = dkimFound ? 'ok' : 'miss';
      const dkimLabel = dkimFound ? 'Found' : 'Not found';
      const dkimSelectors = (dkim.selectors_found || []).join(', ');
      html += '<div class="protocol-row">';
      html += '<span class="protocol-label">DKIM</span>';
      html += `<span class="protocol-status protocol-${dkimStatus}">${dkimLabel}</span>`;
      if (dkimSelectors) html += `<span class="protocol-detail">Selectors: ${dkimSelectors}</span>`;
      html += '</div>';

      html += '</div></div>';
      return html;
    }

    // ── Domain Registration section ──
    function buildDomainRegistrationSection(domainReg) {
      if (!domainReg) return '';

      const ageDays = domainReg.domain_age_days || 0;
      const ageColor = ageDays < 30 ? 'var(--clr-danger)' : ageDays < 365 ? 'var(--clr-warning)' : 'var(--clr-success)';

      let html = '<div class="posture-card">';
      html += '<div class="posture-card-header">';
      html += '<span>Domain Registration</span>';
      html += `<span class="dnssec-badge ${domainReg.dnssec ? 'dnssec-enabled' : 'dnssec-disabled'}">DNSSEC ${domainReg.dnssec ? 'ON' : 'OFF'}</span>`;
      html += '</div>';
      html += '<div class="posture-card-body">';

      // Age display
      if (domainReg.registration_date) {
        html += `<div class="reg-age" style="color:${ageColor}">${ageDays.toLocaleString()} days</div>`;
        html += '<div class="reg-age-label">Domain Age</div>';
      }

      // Registration date
      if (domainReg.registration_date) {
        html += '<div class="reg-row">';
        html += '<span class="reg-label">Registered</span>';
        html += `<span class="reg-value">${formatDate(domainReg.registration_date)}</span>`;
        html += '</div>';
      }

      // Expiration date
      if (domainReg.expiration_date) {
        html += '<div class="reg-row">';
        html += '<span class="reg-label">Expires</span>';
        html += `<span class="reg-value">${formatDate(domainReg.expiration_date)}</span>`;
        html += '</div>';
      }

      // Last changed
      if (domainReg.last_changed) {
        html += '<div class="reg-row">';
        html += '<span class="reg-label">Last Changed</span>';
        html += `<span class="reg-value">${formatDate(domainReg.last_changed)}</span>`;
        html += '</div>';
      }

      // Registrar
      if (domainReg.registrar) {
        html += '<div class="reg-row">';
        html += '<span class="reg-label">Registrar</span>';
        html += `<span class="reg-value">${domainReg.registrar}</span>`;
        html += '</div>';
      }

      html += '</div></div>';
      return html;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '\u2014';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // ── Combined results renderer ──
    function displayCompleteResults(target, scanData, complianceData, enrichData) {
      const sections = [];
      if (scanData) sections.push('scan');
      if (complianceData) sections.push('compliance');
      if (enrichData) sections.push('enrichment');

      setResultHeader('Complete Analysis: <span class="result-domain">' + target + '</span>');

      let html = '';

      // Two-column: enrichment + compliance side by side
      html += '<div class="two-col">';

      // Left column: Company Profile
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Company Profile</div>';
      html += '<div class="col-card-body">';
      if (enrichData) {
        html += buildProfileCard(enrichData, false);
      } else {
        html += '<div class="empty-state"><p class="pending-text">Loading company profile...</p></div>';
      }
      html += '</div></div>';

      // Right column: Compliance Coverage
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Compliance Coverage</div>';
      html += '<div class="col-card-body">';
      if (complianceData) {
        const result = complianceData.data;
        const s = result.summary;
        html += buildCoverageSection(s, result.pages);
        if (s.frameworks?.length) {
          html += '<div class="frameworks-list">';
          s.frameworks.forEach(f => { html += `<span class="framework-tag">${f}</span>`; });
          html += '</div>';
        }
      } else {
        html += '<div class="empty-state"><p class="pending-text">Discovering compliance pages...</p></div>';
      }
      html += '</div></div>';

      html += '</div>'; // end two-col

      // Interesting subdomains (from scan data)
      html += buildInterestingSubdomainsSection(scanData);

      // Collect subprocessors from compliance for the unified tech list
      const complianceSubprocessors = complianceData?.data?.summary?.subprocessors || [];

      // Second two-column row: Security Findings + Discovered Technologies
      html += '<div class="two-col">';

      // Left column: Security Findings
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Security Findings</div>';
      html += '<div class="col-card-body">';
      if (scanData) {
        const result = scanData.data;
        const checks = result.results || [];
        const { securityFindings } = aggregateChecks(checks);

        if (result.intel_score) {
          const s = result.intel_score;
          html += `<div class="intel-score compact">
            <div class="score-item"><div class="label">Risk Score</div><div class="value risk-${s.risk_level}">${s.score}/100</div></div>
            <div class="score-item"><div class="label">Risk Level</div><div class="value risk-${s.risk_level}">${s.risk_level.toUpperCase()}</div></div>
          </div>`;

          // Email Auth + Domain Registration in complete view
          if (s.email_auth || s.domain_registration) {
            html += '<div class="posture-grid">';
            html += buildEmailAuthSection(s.email_auth);
            html += buildDomainRegistrationSection(s.domain_registration);
            html += '</div>';
          }
        }

        html += buildSecurityFindingsList(securityFindings);
      } else {
        html += '<div class="empty-state"><p class="pending-text">Running security scan...</p></div>';
      }
      html += '</div></div>';

      // Right column: Discovered Technologies
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Discovered Technologies</div>';
      html += '<div class="col-card-body">';
      if (scanData) {
        const checks = scanData.data.results || [];
        const { techCheck } = aggregateChecks(checks);
        html += buildTechnologyList(techCheck, complianceSubprocessors);
      } else {
        html += '<div class="empty-state"><p class="pending-text">Detecting technologies...</p></div>';
      }
      html += '</div></div>';

      html += '</div>'; // end two-col

      setResultBody(html);
    }

    // ── Scan results ──
    function displayScanResults(data) {
      const result = data.data;
      setResultHeader('<span class="result-domain">' + (result.email || result.domain) + '</span>');

      let html = '';
      const checks = result.results || [];

      // Intel score + flags
      if (result.intel_score) {
        const s = result.intel_score;
        html += `<div class="intel-score">
          <div class="score-item">
            <div class="label">Risk Score</div>
            <div class="value risk-${s.risk_level}">${s.score}/100</div>
          </div>
          <div class="score-item">
            <div class="label">Risk Level</div>
            <div class="value risk-${s.risk_level}">${s.risk_level.toUpperCase()}</div>
          </div>
        </div>
        <div class="recommendation recommend-${s.recommendation}">
          Recommendation: ${s.recommendation.toUpperCase()}
        </div>`;

        if (s.flags) {
          html += '<div class="flags">';
          const flagDefs = [
            ['is_disposable_email','Disposable Email'],['is_tor','Tor'],['is_vpn','VPN'],
            ['is_proxy','Proxy'],['is_bot','Bot'],['is_c2','C2 Server'],
            ['is_spam','Spam'],['is_phishing','Phishing'],['is_malware','Malware'],
            ['is_bruteforce','Bruteforce'],['is_new_domain','New Domain'],
            ['is_weak_email_auth','Weak Email Auth']
          ];
          flagDefs.forEach(([k,l]) => {
            html += `<span class="flag ${s.flags[k]?'active':'inactive'}">${l}</span>`;
          });
          html += '</div>';
        }

        if (s.reasons?.length) {
          html += '<div class="section-title">Threat Intelligence Findings</div>';
          s.reasons.forEach(r => {
            html += `<div class="finding high">
              <div class="finding-header"><span class="severity-badge severity-high">ALERT</span> ${r}</div>
            </div>`;
          });
        }

        // Email Auth + Domain Registration posture cards
        if (s.email_auth || s.domain_registration) {
          html += '<div class="posture-grid">';
          html += buildEmailAuthSection(s.email_auth);
          html += buildDomainRegistrationSection(s.domain_registration);
          html += '</div>';
        }
      }

      // Two-column: Security Findings + Discovered Technologies
      html += '<div class="two-col">';

      // Left column: Security Findings
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Security Findings</div>';
      html += '<div class="col-card-body">';
      const { securityFindings, techCheck } = aggregateChecks(checks);
      html += buildSecurityFindingsList(securityFindings);
      html += '</div></div>';

      // Right column: Discovered Technologies
      html += '<div class="col-card">';
      html += '<div class="col-card-header">Discovered Technologies</div>';
      html += '<div class="col-card-body">';
      html += buildTechnologyList(techCheck);
      html += '</div></div>';

      html += '</div>'; // end two-col

      setResultBody(html);
    }

    // ── Compliance results ──
    function displayComplianceResults(data) {
      const result = data.data;
      setResultHeader('Compliance: <span class="result-domain">' + result.domain + '</span>');

      let html = '';
      const s = result.summary;

      // Coverage with inline page links
      html += '<div class="section-title mt-0">Coverage</div>';
      html += buildCoverageSection(s, result.pages);

      // Frameworks
      if (s.frameworks?.length) {
        html += '<div class="section-title">Frameworks Detected</div>';
        html += '<div class="frameworks-list">';
        s.frameworks.forEach(f => {
          html += `<span class="framework-tag">${f}</span>`;
        });
        html += '</div>';
      }

      // Discovered vendors / subprocessors
      if (s.subprocessors?.length) {
        html += '<div class="section-title">Discovered Technologies</div>';
        html += buildTechnologyList(null, s.subprocessors);
      }

      setResultBody(html);
    }

    // ── Enrichment results ──
    function displayEnrichResults(data) {
      const result = data.data;
      const p = result.profile;

      setResultHeader('Enrichment: <span class="result-domain">' + result.domain + '</span>');

      let html = buildProfileCard(data, true);

      // Raw data
      html += `<details><summary>Raw Response</summary><pre>${JSON.stringify(result, null, 2)}</pre></details>`;

      setResultBody(html);
    }

    // ── Helpers ──
    function setResultHeader(title) {
      document.getElementById('resultTitle').innerHTML = `
        <h2>${title}</h2>
        <div class="header-actions">
          <button class="action-btn" onclick="exportJSON()">Export JSON</button>
          <button class="action-btn" onclick="copyReport()">Copy Report</button>
        </div>
      `;
    }

    function setResultBody(html) {
      document.getElementById('resultBody').innerHTML = html;
      document.getElementById('results').classList.add('show');
    }

    function toggleCheck(idx) {
      document.getElementById('check-' + idx).classList.toggle('show');
    }

    function showToast(message) {
      const t = document.getElementById('toast');
      t.textContent = message;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }

    function exportJSON() {
      if (!currentScanData) return;
      const blob = new Blob([JSON.stringify(currentScanData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sleuth-${currentMode}-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Exported as JSON');
    }

    function copyReport() {
      if (!currentScanData) return;
      const text = JSON.stringify(currentScanData, null, 2);
      navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
    }

    updateInputs();
  </script>
</body>
</html>
